<!DOCTYPE html>

<html lang="en">
<head>
	<meta charset="utf-8">
	<title>js-fea Source: feblock.js</title>

	<!--[if lt IE 9]>
	<script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
	<![endif]-->
	<link type="text/css" rel="stylesheet" href="styles/sunlight.default.css">

	
	<link type="text/css" rel="stylesheet" href="styles/site.cerulean.css">
	
</head>

<body>
<div class="container-fluid">
	<div class="navbar navbar-fixed-top navbar-inverse">
		<div class="navbar-inner">
			<a class="brand" href="index.html">js-fea</a>
			<ul class="nav">
				
				<li class="dropdown">
					<a href="modules.list.html" class="dropdown-toggle" data-toggle="dropdown">Modules<b
						class="caret"></b></a>

					<ul class="dropdown-menu ">
						
						<li>
							<a href="module-feblock.html">feblock</a>
						</li>
						
						<li>
							<a href="module-field.html">field</a>
						</li>
						
						<li>
							<a href="module-forceintensity.html">forceintensity</a>
						</li>
						
						<li>
							<a href="module-gcellset.html">gcellset</a>
						</li>
						
						<li>
							<a href="module-material.html">material</a>
						</li>
						
						<li>
							<a href="module-mesh.html">mesh</a>
						</li>
						
						<li>
							<a href="module-types.html">types</a>
						</li>
						
						<li>
							<a href="module-utils.html">utils</a>
						</li>
						

					</ul>
				</li>
				
				<li class="dropdown">
					<a href="classes.list.html" class="dropdown-toggle" data-toggle="dropdown">Classes<b
						class="caret"></b></a>

					<ul class="dropdown-menu ">
						
						<li>
							<a href="module-feblock.DeforSS.html">DeforSS</a>
						</li>
						
						<li>
							<a href="module-feblock.Feblock.html">Feblock</a>
						</li>
						
						<li>
							<a href="module-field.Field.html">Field</a>
						</li>
						
						<li>
							<a href="module-forceintensity.ForceIntensity.html">ForceIntensity</a>
						</li>
						
						<li>
							<a href="module-gcellset.GCellSet.html">GCellSet</a>
						</li>
						
						<li>
							<a href="module-gcellset.GCellSetManifold0.html">GCellSetManifold0</a>
						</li>
						
						<li>
							<a href="module-gcellset.GCellSetManifold1.html">GCellSetManifold1</a>
						</li>
						
						<li>
							<a href="module-gcellset.GCellSetManifold2.html">GCellSetManifold2</a>
						</li>
						
						<li>
							<a href="module-gcellset.GCellSetManifold3.html">GCellSetManifold3</a>
						</li>
						
						<li>
							<a href="module-gcellset.H8.html">H8</a>
						</li>
						
						<li>
							<a href="module-gcellset.L2.html">L2</a>
						</li>
						
						<li>
							<a href="module-gcellset.P1.html">P1</a>
						</li>
						
						<li>
							<a href="module-gcellset.Q4.html">Q4</a>
						</li>
						
						<li>
							<a href="module-material.DeforSSLinElBiax.html">DeforSSLinElBiax</a>
						</li>
						
						<li>
							<a href="module-material.DeforSSLinElTriax.html">DeforSSLinElTriax</a>
						</li>
						
						<li>
							<a href="module-material.DeforSSLinElUniax.html">DeforSSLinElUniax</a>
						</li>
						
						<li>
							<a href="module-material.Material.html">Material</a>
						</li>
						
						<li>
							<a href="module-mesh-Mesh.html">Mesh</a>
						</li>
						

					</ul>
				</li>
				
			</ul>
		</div>
	</div>

	<div class="row-fluid">

		
			<div class="span12">
				
				<div id="main">
					


		<h1 class="page-title">Source: feblock.js</h1>
    
    <section>
        <article>
            <pre class="sunlight-highlight-javascript linenums">/*global require*/
// dependencies
var _ = require('./core.utils');
var assert = _.assert;
var check = _.check;
var isObject = check.object;
var isFunction = check.function;
var isAssigned = check.assigned;
var isa = check.instance;
var isMatrixOfDimension = check.isMatrixOfDimension;
var array2d = _.array2d;
var array1d = _.array1d;
var defineContract = _.defineContract;

var numeric = require('./core.numeric');
var size = numeric.size;
var transpose = numeric.transpose;
var dot = numeric.dot;
var add = numeric.add;
var mul = numeric.mul;
var inv = numeric.inv;
var norm = numeric.norm;
var colon = numeric.colon;
var ixUpdate_ = numeric.ixUpdate_;

var Material = require('./material').Material;
var GCellSet = require('./gcellset').GCellSet;
var IntegrationRule = require('./integrationrule').IntegrationRule;
var ElementMatrix = require('./system.matrix').ElementMatrix;
var ElementVector = require('./system.vector').ElementVector;

/**
 * @module feblock
 */

/**
 * Finite element block class.
 * @class
 * @abstract
 */
exports.Feblock = function Feblock() {};
var Feblock = exports.Feblock;

/**
 * Returns the gcellset. Useful for visualization.
 * @returns {module:gcellset.GCellSet}
 */
exports.Feblock.prototype.gcells = function() {
  return this._gcells;
};

/**
 * Returns the topology. Useful for visualization.
 * @returns {module:topology.Topology}
 */
exports.Feblock.prototype.topology = function() {
  return this._gcells.topology();
};

/**
 * @typedef module:feblock.DeforSSInitOption
 * @property {module:material.Material} material
 * @property {module:gcellset.GCellSet} gcells
 * @property {module:integrationrule.IntegrationRule} integrationRule
 */

/**
 * @class
 * @extends module:feblock.Feblock
 * @param {module:feblock.DeforSSInitOption} options
 */
exports.DeforSS = function DeforSS(options) {
  this._mater = null;
  this._gcells = null;
  this._ir = null;
  this._rm = null;

  if (!isObject(options))
    throw new Error('DeforSS#constructor(options): option is not a valid ' +
                    'DeforSSInitOption.');

  if (!isa(options.material, Material))
    throw new Error('DeforSS#constructor(options):' +
                    ' options.material is not a instance of Material');

  if (!isa(options.gcells, GCellSet))
    throw new Error('DeforSS#constructor(options):' +
                    'options.gcells is not a instance of GCellSet');

  if (!isa(options.integrationRule, IntegrationRule))
    throw new Error('DeforSS#constructor(options):' +
                    'options.integrationRule is not a instance of integrationRule');

  this._mater = options.material;
  this._gcells = options.gcells;
  this._ir = options.integrationRule;
  if (isAssigned(options.rm)) this._rm = options.rm;

  var dim = this._gcells.dim();
  switch (dim) {
  case 1:
    this.hBlmat = this._blmat1;
    break;
  case 2:
    if (this._gcells.axisSymm())
      throw new Error('DeforSS::hBlmat() for axixSymm, dim = ' +
                      dim + ' is not implemented.');
    else
      this.hBlmat = this._blmat2;
    break;
  case 3:
    this.hBlmat = this._blmat3;
    break;
  default:
    throw new Error('DeforSS::hBlmat() for dim ' + dim + ' is not implemented.');
  }
};
var DeforSS = exports.DeforSS;
DeforSS.prototype = Object.create(Feblock.prototype);
DeforSS.prototype.constructor = DeforSS;

/**
 * Compute the strain-displacement matrix (B) for a one-manifold element.
 * @param {module:types.Matrix} N - matrix of basis function values.
 * @param {module:types.Matrix} Ndersp - matrix of basis function
 * gradients.
 * @param {module:types.Matrix} c - spatial coordinates.
 * @param {module:types.Matrix|undefined} Rm - orthogonal matrix
 * represent the global-to-local transformation.
 * @returns {module:types.Matrix} B matrix.
 */
exports.DeforSS.prototype._blmat1 = function(N, Ndersp, c, Rm) {
  var nfn = size(Ndersp, 1);
  var dim = size(c, 2);
  var B = array2d(1, nfn*dim, 0);
  var i, indices;

  var s, dimi_1, from, to, span;

  if (Rm) {
    s = Rm.map(function(row) {
      return row[0];
    });

    for (i = 1; i &lt;= nfn; ++i) {
      from = dim*(i-1);
      to = dim*i-1;
      span = to - from;
      indices = array1d(span+1, function(x) {
        return from + x;
      });
      indices.forEach(function(idx, j) {
        B[0][idx] = Ndersp[i-1][0]*s[j];
      });
    }
  } else {
    throw new Error('_blmat1: not implmented when !Rm');
  }
  return B;
};

/**
 * Compute the strain-displacement matrix (B) for a two-manifold element.
 * @param {module:types.Matrix} N - matrix of basis function values.
 * @param {module:types.Matrix} Ndersp - matrix of basis function
 * gradients.
 * @param {module:types.Matrix} c - spatial coordinates.
 * @param {module:types.Matrix|undefined} Rm - orthogonal matrix
 * represent the global-to-local transformation.
 * @returns {module:types.Matrix} B matrix.
 */
exports.DeforSS.prototype._blmat2 = function(N, Ndersp, c, Rm) {
  var nfn = size(Ndersp, 1);
  var dim = size(c, 2);
  var B = array2d(3, nfn*dim, 0);
  var i, cols, vals;

  if (Rm) {
    for (i = 1; i &lt;= nfn; ++i) {
      cols = colon(dim*(i-1)+1, dim*i);
      vals = [
        [ Ndersp[i-1][0], 0 ],
        [ 0, Ndersp[i-1][1] ],
        [ Ndersp[i-1][1], Ndersp[i-1][0] ]
      ];
      // console.log("B = ", B);
      // console.log("cols = ", cols);
      // console.log("vals = ", vals);
      B = ixUpdate_(B, ':', cols, vals);
      // console.log("B = ", B);
    }
  } else
    throw new Error('_blmat1: not implmented when !Rm');
  return B;
};

/**
 * Compute the strain-displacement matrix (B) for a 3-manifold element.
 * @param {module:types.Matrix} N - matrix of basis function values.
 * @param {module:types.Matrix} Ndersp - matrix of basis function
 * gradients.
 * @param {module:types.Matrix} c - spatial coordinates.
 * @param {module:types.Matrix|undefined} Rm - orthogonal matrix
 * represent the global-to-local transformation.
 * @returns {module:types.Matrix} B matrix.
 */
exports.DeforSS.prototype._blmat3 = function(N, Ndersp, c, Rm) {
  var nfn = size(Ndersp, 1);
  var B = array2d(6, nfn*3);

  var i, k, RmT, indices, part;
  if (!isAssigned(Rm)) {
    for (i = 0; i &lt; nfn; ++i) {
      k = 3*i;
      B[0][k] = Ndersp[i][0];
      B[1][k+1] = Ndersp[i][1];
      B[2][k+2] = Ndersp[i][2] ;
      B[3][k] = Ndersp[i][1]; B[3][k+1]= Ndersp[i][0];
      B[4][k] = Ndersp[i][2]; B[4][k+2]= Ndersp[i][0];
      B[5][k+1] = Ndersp[i][2]; B[5][k+2]= Ndersp[i][1];
    }
  } else {
    RmT = transpose(Rm);
    for (i = 1; i &lt;= nfn; ++i) {
      indices = colon(3*(i-1)+1, 3*i);
      part = [
        [ Ndersp[i-1][0], 0, 0 ],
        [ 0, Ndersp[i-1][1], 0 ],
        [ 0, 0, Ndersp[i-1][2] ],
        [ Ndersp[i-1][1], Ndersp[i-1][0], 0 ],
        [ Ndersp[i-1][2], 0, Ndersp[i-1][0] ],
        [ 0, Ndersp[i-1][2], Ndersp[i-1][1] ]
      ];
      part = dot(part, RmT);
      ixUpdate_(B, ':', indices, part);
    }
  }

  return B;
};

/**
 * Return a list of element matrices that can be assembled to global
 * stiffness matrix.
 * @param {module:field.Field} geom - geometric field.
 * @param {module:field.Field} u - displacement field.
 * @returns {Array} array of {@link module:system.matrix.ElementMatrix }
 */
DeforSS.prototype.stiffness = function(geom, u) {
  var gcells = this._gcells;
  var cellSize = gcells.cellSize();
  var ir = this._ir;

  var pc = ir.paramCoords();
  var w = ir.weights();
  var npts = ir.npts();

  var Ns = [], Nders = [];
  var j;
  for (j = 0; j &lt; npts; ++j) {
    Ns[j] = gcells.bfun(pc[j]);
    Nders[j] = gcells.bfundpar(pc[j]);
  }

  var rmh = null;
  if (isFunction(this._rm)) rmh = this._rm;
  var rm = this._rm;
  var mat = this._mater;

  var conns = gcells.conn();
  // labels??
  var numCells = gcells.count();
  var Ke = new Array(numCells);
  var eqnums = new Array(numCells);

  var dim = geom.dim();
  // console.log("dim = ", dim);
  var i;
  for (i = 0; i &lt; numCells; ++i) {
    eqnums[i] = u.gatherEqnumsVector(conns[i]);
    Ke[i] = array2d(dim*cellSize, dim*cellSize, 0);
  }

  var allIds = array1d(geom.nfens(), function(i) { return i + 1; });
  var xs = geom.gatherValuesMatrix(allIds);

  var conn, x, c, J, Ndersp, Jac, B, D, delta;
  for (i = 0; i &lt; numCells; ++i) {
    conn = conns[i];
    x = conn.map(function(id) { return xs[id-1]; });

    for (j = 0; j &lt; npts; ++j) {
      c = dot(transpose(Ns[j]), x);
      J = dot(transpose(x), Nders[j]);
      // console.log("c = ", c);
      // console.log("J = ", J);
      if (rmh) rm = rmh(c, J);

      if (rm) {
        // TODO: figure out rm
        Ndersp = dot(Nders[j], inv(dot(transpose(rm), J)));
      } else {
        Ndersp = dot(Nders[j], inv(J));
      }
      // console.log("Ndersp = ", Ndersp);

      Jac = gcells.jacobianVolumn(conn, Ns[j], J, x);
      // console.log("Jac = ", Jac);
      if (Jac &lt; 0) throw new Error('Non-positive Jacobian');

      // TODO: _hBlmat
      B = this.hBlmat(Ns[j], Ndersp, c, rm);
      // console.log("B = ", B);
      // size(B)
      // console.log("size(B) = ", size(B));
      D = mat.tangentModuli({ xyz: c });
      // console.log("D = ", D);

      // var jw = Jac*w[j];
      // var mid = mul(D, Jac*w[j]);
      // console.log("mid = ", mid);
      // console.log("B = ", B);
      // console.log("B' = ", transpose(B));
      // console.log("dot(transpose(B), mid) = ", dot(transpose(B), mid));

      // console.log("Jac = ", Jac);
      // console.log("mul(D, Jac*w[j]) = ", mul(D, Jac*w[j]));
      // console.log("dot(transpose(B), mul(D, Jac*w[j])) = ", dot(transpose(B), mul(D, Jac*w[j])));
      delta = dot(dot(transpose(B), mul(D, Jac*w[j])), B);
      // console.log("delta = ", delta);
      // console.log("delta = ", delta);

      // delta = dot(dot(transpose(B), mul(D, Jac*w[j])), B);
      // console.log("Ke[j] = ", Ke[j]);
      Ke[i] = add(Ke[i], delta);
      // console.log("Ke[j] = ", Ke[j]);
    }
  }

  var elementMatrices = Ke.map(function(mat, i) {
    return new ElementMatrix(mat, eqnums[i]);
  });

  return elementMatrices;
};


DeforSS.prototype.noneZeroEBCLoads = function(geom, u) {
  var gcells = this._gcells;
  var ncells = gcells.count();
  var conns = gcells.conn();

  var evs = [];

  var i, conn, pu, feb, ems, Ke, f, eqnums;
  for (i = 0; i &lt; ncells; ++i) {
    conn = conns[i];
    pu = u.gatherPrescirbedValues(conn);
    if (norm(pu) !== 0) {
      // console.log("this._gcells.subset(i) = ", this._gcells.subset([i]));
      feb = new DeforSS({
        material: this._mater,
        gcells: this._gcells.subset([i]),
        integrationRule: this._ir,
        rm: this._rm
      });
      // this._gcells = this._gcells.subset([i]);
      ems = feb.stiffness(geom, u);
      // console.log("ems = ", ems);
      Ke = ems[0].matrix;
      // console.log("Ke = ", Ke);

      f = mul(-1, dot(Ke, pu));
      // console.log("f = ", f);
      eqnums = u.gatherEqnumsVector(conn);
      evs.push(new ElementVector(f, eqnums));
    }
  }
  return evs;
};

exports.DeforSS = DeforSS;
</pre>
        </article>
    </section>





				</div>

				<div class="clearfix"></div>
				<footer>
					
					
		<span class="copyright">
		Li Ge Copyright 2015
		</span>
					<br />
					
		<span class="jsdoc-message">
		Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.3.0-alpha5</a>
		on Wed Mar 18 2015 16:37:40 GMT-0700 (PDT) using the <a href="https://github.com/terryweiss/docstrap">DocStrap template</a>.
		</span>
				</footer>
			</div>

			
			<br clear="both">
		</div>

	</div>
	<script src="scripts/sunlight.js"></script>
	<script src="scripts/sunlight.javascript.js"></script>
	<script src="scripts/sunlight-plugin.doclinks.js"></script>
	<script src="scripts/sunlight-plugin.linenumbers.js"></script>
	<script src="scripts/sunlight-plugin.menu.js"></script>
	<script src="scripts/jquery.min.js"></script>
	<script src="scripts/jquery.scrollTo.js"></script>
	<script src="scripts/jquery.localScroll.js"></script>
	<script src="scripts/bootstrap-dropdown.js"></script>
	<script src="scripts/toc.js"></script>


	<script>  Sunlight.highlightAll({lineNumbers:true,  showMenu: true, enableDoclinks :true}); </script>

	<script>
		$( function () {
			$( "#toc" ).toc( {
				selectors   : "h1,h2,h3,h4",
				showAndHide : false,
				scrollTo    : 60
			} );
			$( "#toc>ul" ).addClass( "nav nav-pills nav-stacked" );
			$( "#main span[id^='toc']" ).addClass( "toc-shim" );

		} );
	</script>

	

</body>
</html>
